<?xml version="1.0" encoding="UTF-8"?>

<!--build.xml originally generated by maven from project.xml but since 
    modified by St.Ack.  This maven-generated build.xml is subsequently patched
    adding source=1.4 flags to javac and javadocs targets and preventing the 
    maven download of jars instead using the content of the lib dir.

    Be sure to make the 'version' property match the currentVersion in
    project.xml.
    
    Note the 'dist' target is dependent on 'test' target. To run the test
    target, you'll need to satisfy a junit ant task dependency. The junit jar
    needs to be in SAME location as the ant optional.jar that contains the
    junit ant task.  See http://ant.apache.org/manual/OptionalTasks/junit.html.
    Since we do not supply a build.sh script expecting the developer to have 
    ant installed, the developer will need to take care of resolving the junit
    dependency for their ant install before they can run the 'test' target or 
    the subsequent 'dist' target.
 -->

<project default="jar" name="heritrix" basedir=".">

    <!--Be sure to make this 'version' property match the currentVersion in
        project.xml.
     -->
    <property name="version" value="0.6.0" />

    <property name="src.libdir" value="lib" />
    <property name="src.confdir" value="src/conf" />
    <property name="src.webappsdir" value="src/webapps" />
    <target name="help">
        <echo message="Type 'ant -projecthelp' for more info." />  
    </target>

  <property name="targetdir" value="target" />
  <property name="libdir" value="target/lib" />
  <property name="confdir" value="target/conf" />
  <property name="webappsdir" value="target/webapps" />
  <property name="classesdir" value="target/classes" />
  <property name="testclassesdir" value="target/test-classes" />
  <property name="testreportdir" value="target/test-reports" />
  <property name="testtmpdir" value="target/test-tmp" />
  <property name="distdir" value="dist" />
  <property name="javadocdir" value="dist/docs/api" />
  <property name="final.name" value="heritrix-${version}" />

  <target name="init" description="Create initial setup under ${targetdir}">
    <mkdir dir="${libdir}">
    </mkdir>
    <copy todir="${libdir}" >
      <fileset dir="${src.libdir}">
        <include name="*.jar">
        </include>
      </fileset>
    </copy>

    <filter token="VERSION" value="${version}" />
    <mkdir dir="${confdir}">
    </mkdir>
        <!--Copy conf dir.  Be careful w/ filtering.  It ruins truststores so
            exclude those when filtering and copy after w/ filtering off.
         -->
        <copy todir="${confdir}" filtering="true">
          <fileset dir="${src.confdir}" >
            <exclude name="*cacerts" />
          </fileset>
        </copy>
        <copy todir="${confdir}">
          <fileset dir="${src.confdir}" >
            <include name="*cacerts" />
          </fileset>
        </copy>

    <mkdir dir="${webappsdir}">
    </mkdir>
    <!--Do the copy like this doing non-jpg first and then gif.
        Otherwise, ant breaks the jpgs because it interpolates.
      -->
    <copy todir="${webappsdir}" filtering="true">
      <fileset dir="${src.webappsdir}">
        <exclude name="**/*.gif" />
      </fileset>
    </copy>
    <copy todir="${webappsdir}" filtering="false">
      <fileset dir="${src.webappsdir}">
        <include name="**/*gif" />
      </fileset>
    </copy>
  </target>

  <target name="compile" description="Compile code" depends="init">
    <mkdir dir="${classesdir}">
    </mkdir>
    <javac destdir="${classesdir}" deprecation="true" debug="true"
        optimize="false" excludes="**/package.html" source="1.4">
      <src>
        <pathelement location="src/java">
        </pathelement>
      </src>
      <classpath>
        <fileset dir="${libdir}">
          <include name="*.jar">
          </include>
        </fileset>
      </classpath>
    </javac>
  </target>
  
  <target name="jar" description="Create jars and wars" depends="compile,test">
    <jar jarfile="target/${final.name}.jar" excludes="**/package.html"
            basedir="${classesdir}" />
    <war destfile="target/webapps/admin.war"
            webxml="target/webapps/admin/WEB-INF/web.xml"
            basedir="target/webapps/admin" />
    <war destfile="target/webapps/selftest.war"
            webxml="target/webapps/selftest/WEB-INF/web.xml"
            basedir="target/webapps/selftest" />
    <war destfile="target/webapps/root.war"
            webxml="target/webapps/root/WEB-INF/web.xml"
            basedir="target/webapps/root" />
  </target>

  <target name="clean" description="Clean up the generated directories">
    <delete dir="${targetdir}">
    </delete>
    <delete dir="${distdir}" />
  </target>

  <target name="dist" description="Create a distribution" 
        depends="jar, javadoc">
    <mkdir dir="dist">
    </mkdir>
    <copy todir="dist" filtering="true">
      <fileset dir="${basedir}" includes="LICENSE*, README*">
      </fileset>
    </copy>
    <!--Copy over the heritrix jar.-->
    <copy todir="dist" >
        <fileset dir="${targetdir}">
            <include name="*.jar" />
        </fileset>
    </copy>
    <copy todir="dist/lib" >
        <fileset dir="${src.libdir}" />
    </copy>
    <copy todir="dist/conf" >
        <fileset dir="${confdir}" />
    </copy>
    <copy todir="dist/webapps">
        <fileset dir="${webappsdir}" >
            <include name="**/*.war" />
        </fileset>
    </copy>
    <!--Copy in the startup scripts and set their permissions.-->
    <copy todir="dist/bin">
        <fileset dir="src/scripts">
            <include name="heritrix*"/>
        </fileset>
   </copy>
    <chmod perm="ugo+rx" >
      <fileset dir="dist/bin">
        <include name="heritrix*"/>
      </fileset>
    </chmod>
  </target>


  <target name="test" description="o Run the test cases" if="test.failure"
        depends="internal-test">
    <fail message="There were test failures.">
    </fail>
  </target>
  <target name="internal-test" depends="compile-tests">
    <mkdir dir="${testreportdir}" />
    <junit dir="./" failureproperty="test.failure" printSummary="yes"
        fork="true" haltonerror="true">
      <sysproperty key="basedir" value="." />
      <sysproperty key="testtmpdir" value="${testtmpdir}" />
      <formatter type="xml">
      </formatter>
      <formatter usefile="false" type="plain">
      </formatter>
      <classpath>
        <fileset dir="${libdir}">
          <include name="*.jar">
          </include>
        </fileset>
        <pathelement path="${testclassesdir}">
        </pathelement>
        <pathelement path="${classesdir}">
        </pathelement>
      </classpath>
      <batchtest todir="${testreportdir}">
        <fileset dir="src/java">
          <include name="**/*Test.java">
          </include>
          <exclude name="**/*SelfTest.java">
          </exclude>
        </fileset>
      </batchtest>
    </junit>
  </target>
  <target name="compile-tests" depends="compile">
    <mkdir dir="${testclassesdir}">
    </mkdir>
    <javac destdir="${testclassesdir}" deprecation="true" debug="true" optimize="false" excludes="**/package.html" source="1.4">
      <src>
        <pathelement location="src/java">
        </pathelement>
      </src>
      <classpath>
        <fileset dir="${libdir}">
          <include name="*.jar">
          </include>
        </fileset>
        <pathelement path="${classesdir}">
        </pathelement>
      </classpath>
    </javac>
  </target>
  <target name="javadoc" description="o Generate javadoc" depends="jar" >
    <mkdir dir="${javadocdir}">
    </mkdir>
    <tstamp>
      <format pattern="2003-yyyy" property="year">
      </format>
    </tstamp>
    <property name="copyright" value="Copyright &amp;copy;  Internet Archive. All Rights Reserved.">
    </property>
    <property name="title" value="Heritrix ${version} API">
    </property>
    <javadoc use="true" private="true" destdir="${javadocdir}" author="true" version="true" sourcepath="src/java" packagenames="org.archive.*" source="1.4">
      <classpath>
        <fileset dir="${libdir}">
          <include name="*.jar">
          </include>
        </fileset>
        <pathelement location="target/${final.name}.jar">
        </pathelement>
      </classpath>
    </javadoc>
  </target>
</project>
