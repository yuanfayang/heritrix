<?xml version="1.0"?>
<project 
    default="dist"
    xmlns:j="jelly:core" 
    xmlns:define="jelly:define" 
    xmlns:doc="doc" 
    xmlns:artifact="artifact" 
    xmlns:util="jelly:util" 
    xmlns:maven="jelly:maven"
    xmlns:ant="jelly:ant">

    <preGoal name="xdoc:jelly-transform">
        <attainGoal name="faq"/>
        <attainGoal name="heritrix-javadoc"/>
        <attainGoal name="docbook"/>
    </preGoal> 

    <goal name="docbook">
        <attainGoal name="sdocbook:generate-html"/>
    </goal>

    <preGoal name="java:jar-resources"> 
        <filter token="VERSION" value="${pom.currentVersion}" /> 
    </preGoal> 

    <postGoal name="dist:prepare-bin-filesystem">
        <echo>[Heritrix] dist:prepare-bin-filesystem postGoal</echo>

        <!--Add the lib dir to our binary distribution.-->
        <copy todir="${maven.dist.bin.assembly.dir}/lib">
          <fileset dir="./lib">
            <include name="*.jar"/>
          </fileset>
        </copy>

        <!--Set filter token used in a few instances below.-->
        <filter token="VERSION" value="${pom.currentVersion}" />

        <!--Add the conf dir to our binary distribution.  Be careful w/
            filtering.  It ruins truststores so exclude those when during 
            filter copy.  Copy truststores separately afterward.
         -->
        <copy todir="${maven.dist.bin.assembly.dir}/conf" filtering="true">
          <fileset dir="./src/conf">
            <exclude name="*.cacerts"/>
          </fileset>
        </copy>
        <copy todir="${maven.dist.bin.assembly.dir}/conf">
          <fileset dir="./src/conf">
            <include name="*cacerts"/>
          </fileset>
        </copy>

        <!--Copy to a bin dir the heritrix start script.-->
        <copy todir="${maven.dist.bin.assembly.dir}/bin">
          <fileset dir="${maven.src.dir}/scripts">
            <include name="*heritrix"/>
            <include name="arcreader"/>
            <include name="hoppath*"/>
          </fileset>
        </copy>

        <!--Set permission on scripts just copied.-->
        <!--The below succeeds changing the mode on the executables but 
            the subsequent dist:build-bin task ant tar'ring removes the
            execute bit.  Need to replace the dist:build-bin task w/ 
            a version that will preserve the execute bit on the script
            files (Putting the task in here whole doesn't work).-->
        <chmod perm="ugo+rx" >
          <fileset dir="${maven.dist.bin.assembly.dir}/bin">
            <include name="*heritrix"/>
          </fileset>
        </chmod>

        <!--Copy articles to the docs dir.-->
        <attainGoal name="docbook"/>
        <mkdir dir="${maven.dist.bin.assembly.dir}/docs/articles/" />
        <copy todir="${maven.dist.bin.assembly.dir}/docs/articles/">
          <fileset dir="${maven.build.dir}/docs/articles/" />
        </copy>

        <!--Copy webapps to build directory w/ filtering enabled.
            Do the copy like this doing non-jpg first and then gif.
            Otherwise, ant breaks the jpgs because it interpolates.
         -->
        <copy todir="${maven.build.dir}/webapps" filtering="true">
          <fileset dir="${maven.src.dir}/webapps">
            <exclude name="**/*.gif"/>
            <exclude name="**/*.jpg"/>
            <exclude name="**/*.png"/>
            <exclude name="**/*.swf"/>
            <exclude name="**/jetty-web.xml"/>
          </fileset>
        </copy>
        <copy todir="${maven.build.dir}/webapps" filtering="false">
          <fileset dir="${maven.src.dir}/webapps">
            <include name="**/*.gif"/>
            <include name="**/*.jpg"/>
            <include name="**/*.png"/>
            <exclude name="**/*.swf"/>
          </fileset>
        </copy>

        <!--Copy docs into the admin webapp so available to UI.-->
        <mkdir dir="${maven.build.dir}/webapps/admin/docs/articles/" />
        <copy todir="${maven.build.dir}/webapps/admin/docs/articles/">
          <fileset dir="${maven.build.dir}/docs/articles/" />
        </copy>

        <!--Compile jsp pages into a jar.
            TODO: Make this conditional.
         -->
        <attainGoal name="jspc" />

        <!--Now create war files of what is in build directory.-->
        <property name="webapps.dir" value="${maven.build.dir}/webapps" />
        <war destfile="${maven.build.dir}/admin.war"
            webxml="${webapps.dir}/admin/WEB-INF/web.xml"
            basedir="${webapps.dir}/admin" />
        <war destfile="${maven.build.dir}/selftest.war"
            webxml="${webapps.dir}/selftest/WEB-INF/web.xml"
            basedir="${webapps.dir}/selftest" />
        <war destfile="${maven.build.dir}/root.war"
            webxml="${webapps.dir}/root/WEB-INF/web.xml"
            basedir="${webapps.dir}/root" />

        <!--Copy over the just made war files into the distribution copy.-->
        <copy todir="${maven.dist.bin.assembly.dir}/webapps">
          <fileset dir="${maven.build.dir}">
            <include name="*.war"/>
          </fileset>
        </copy>

    </postGoal>

    <postGoal name="dist:prepare-src-filesystem">
        <echo>[Heritrix] dist:prepare-src-filesystem postGoal</echo>
        <!--Add the lib dir to our binary distribution.-->
        <copy todir="${maven.dist.src.assembly.dir}/lib">
          <fileset dir="./lib">
            <include name="*.jar"/>
          </fileset>
        </copy>
    </postGoal>

    <goal name="selftest" 
        prereqs="dist:build-bin"
            description="Run selftest and fail if we don't pass." >
        <property name="maven.dist.dir" 
            value="${maven.build.dir}/distributions" />  
        <property name="maven.selftest.dir" 
            value="${maven.build.dir}/selftest" />  
        <delete dir="${maven.selftest.dir}" />
        <mkdir dir="${maven.selftest.dir}" />
        <property name="${maven.selftest.dir}"
           value="${maven.dist.dir}/${maven.final.name}" />  
        <copy todir="${maven.selftest.dir}" 
           file="${maven.dist.dir}/${maven.final.name}.tar.gz" />  
        <property name="basename"
           value="${maven.selftest.dir}/${maven.final.name}" />  
        <gunzip src="${basename}.tar.gz" dest="${basename}.tar" />
        <untar src="${basename}.tar" dest="${maven.selftest.dir}" />
        <chmod file="${basename}/bin/*" perm="a+rx" />
        <chmod file="${basename}/bin/*" perm="a+rx" />
        <exec failonerror="true"
                timeout="300000"
                executable="${basename}/bin/foreground_heritrix">
            <arg line="--selftest" />
            <arg line="--port=8083" />
        </exec>
       
    </goal>

    <goal name="jspc">
        <!--Compile down to servlets all in the ${webapp.name} webapp
            (Set this ant property before calling this goal).  Compile the 
            generated java classes.  Make a jar of them and install under
            the webapp/lib dir.  Add web.xml fragment that lists all servlets
            to the web.xml.
            
            Currently does admin webapp only.
         -->
        <property name="webapp.name" value="admin" />
        <echo>[jspc] Precompiling ${webapp.name} jsp pages.</echo>
        <property name="jspc" value="${maven.build.dir}/jspc/${webapp.name}" />
        <property name="jsp.jar" value="${jspc}/jsp.jar" />
        <property name="web.fragment" value="${jspc}/web-fragment.xml" />
        <property name="jspc.src" value="${jspc}/src" />
        <property name="jspc.classes" value="${jspc}/classes" />
        <property name="webapp.src.dir" value="${maven.src.dir}/webapps" />
        <property name="webinf"
            value="${maven.build.dir}/webapps/${webapp.name}/WEB-INF" />
        <!--Make a couple of dirs.-->
        <mkdir dir="${jspc.src}" />
        <mkdir dir="${jspc.classes}" />
        <!--Classpath to use in the believe.-->
        <path id="jspc.classpath">
            <path  refid="maven.dependency.classpath" />
            <pathelement path="${maven.build.dest}" />
        </path>
        <!--Run the compilation of the jsp pages. Note, jasper has its own
            included ant task but ant also comes w/ a jspc.  We use the ant
            one below.  The jasper one gave me grief trying to figure out
            exclude of 'include' dir.
         -->
        <jspc destdir="${jspc.src}" srcdir="${webapp.src.dir}/${webapp.name}"
            verbose="100" package="org.archive.crawler.jspc.${webapp.name}"
            webinc="${web.fragment}" classpathref="jspc.classpath"
            uriroot="${webapp.src.dir}/${webapp.name}" >
                <!--This include/exclude mechanism is really contrary.
                    The below seems to work properly though keeping the
                    include out of the fragments and out of the path of
                    our compiler; nothing under include is compilable
                    but its needed.
                 -->
                <exclude name="**/include/*.jsp"/>
        </jspc>
        <javac sourcepath="" srcdir="${jspc.src}" destdir="${jspc.classes}" 
            classpathref="jspc.classpath" />
        <loadfile srcFile="${web.fragment}" property="fragment"
            failonerror="true" />
        <replace file="${webinf}/web.xml"
            token="&lt;!--[INSERT JSP COMPILE SERVLET WEB FRAGMENT HERE]--&gt;"
            value="${fragment}" />
        <!--Jar up classes and copy into webapp/lib.-->
        <property name="webapp.lib" value="${webinf}/lib" />
        <jar destfile="${jsp.jar}" basedir="${jspc.classes}" />
        <mkdir dir="${webapp.lib}" />
        <copy todir="${webapp.lib}" file="${jsp.jar}" /> 
    </goal>

    <goal name="site:update-sourceforge">
        <!--This goal will update sourceforge crawler.archive.org site. Assumes
            maven.username has been defined in project.properties or in a 
            build.properties, and that that users public ssh key has been
            uploaded totheir sourceforge preferences (see
            http://sourceforge.net/docman/display_doc.php?docid=761&group_id=1)
            and that this key has no password associated (Means that 
            we get ssh CVS access w/o having to supply password).

            Note, this goal may give out a couple of lines like the below but
            these are harmless:
            
                [exec] failed to set permissions on . : Operation not permitted

            We use this new goal rather than 'site:sshdeploy' because we don't 
            want to totally overwrite the htdoc content up on sourceforge.
         -->
        <exec executable="rsync" >
            <arg value="--quiet" />
            <arg value="--archive" />
            <arg value="--rsh=ssh" />
            <arg
              value="${maven.build.dir}/docs/"/>
            <arg value="${maven.username}@crawler.archive.org:/home/groups/a/ar/archive-crawler/htdocs/" />
        </exec>
    </goal>

  <!--Below we our own version of the default javadoc plugin.
      Override is because default tool does not copy doc-files nor
      package.html files.  The below is ugly but there is no other means left
      to us when the plugin only passes java files to the javadoc ant task.
    -->
  <goal name="heritrix-javadoc"
        prereqs="xdoc:init"
        description="Generate API documentation (Override of the default
        maven task because default leaves out package.html and doc-files)">
                                                                                
    <j:if test="${sourcesPresent == 'true'}">
      <ant:mkdir dir="${maven.javadoc.destdir}"/>
                                                                                
      <!-- Get the year to display in the Javadocs -->
      <ant:tstamp>
         <ant:format property="currentYear" pattern="yyyy"/>
      </ant:tstamp>
      <ant:tstamp>
        <j:choose>
          <j:when test="${pom.inceptionYear.equals(currentYear)}">
            <ant:format property="year" pattern="yyyy"/>
          </j:when>
          <j:otherwise>
            <ant:format property="year" pattern="${pom.inceptionYear}-yyyy"/>
          </j:otherwise>
        </j:choose>
      </ant:tstamp>
                                                                                
      <ant:property name="copyright"
        value="Copyright &amp;copy; ${year} ${pom.organization.name}. All Rights Reserved." />
                                                                                
      <!-- calculate online/offline mode -->
      <j:set var="online" value="${maven.javadoc.mode.online}"/>
      <j:if test="${empty(online)}">
        <j:set var="online" value="${maven.mode.online}"/>
      </j:if>
                                                                                
      <j:choose>
        <j:when test="${online}">
          <util:tokenize var="links" delim="," trim="true">${maven.javadoc.links}</util:tokenize>
          <j:forEach var="link" items="${links}">
            <ant:echo>Linking with API information from ${link.trim()} ...</ant:echo>
          </j:forEach>
        </j:when>
        <j:otherwise>
          <util:tokenize var="links" delim="," trim="true">${maven.javadoc.offlineLinks}</util:tokenize>
          <j:forEach var="link" items="${links}">
            <ant:echo>Linking offline API information from ${link.trim()} ...</ant:echo>
          </j:forEach>
        </j:otherwise>
      </j:choose>
                                                                                
      <j:set var="maxMemory" value="${maven.javadoc.maxmemory}" />
                                                                                
      <ant:mkdir dir="${maven.build.dir}/javadoc/" />
      <ant:record name="${maven.build.dir}/javadoc/report.txt" action="start" /> 
      <ant:javadoc
        packagenames="${pom.package}.*"
        destdir="${maven.javadoc.destdir}"
        author="${maven.javadoc.author}"
        public="${maven.javadoc.public}"
        package="${maven.javadoc.package}"
        private="${maven.javadoc.private}"
        version="${maven.javadoc.version}"
        use="${maven.javadoc.use}"
        windowtitle="${maven.javadoc.windowtitle}"
        doctitle="${maven.javadoc.windowtitle}"
        bottom="${copyright}"
        additionalparam="${maven.javadoc.additionalparam}"
        useexternalfile="${maven.javadoc.useexternalfile}"
            sourcepath="${pom.build.sourceDirectory}" 
            overview="${pom.build.sourceDirectory}/overview.html" 
            source="${maven.javadoc.source}" >
                                                                                
        <ant:classpath>
          <ant:path refid="maven.dependency.classpath"/>
          <ant:path location="${maven.build.dest}"/>
        </ant:classpath>
     </ant:javadoc>

      <ant:record name="${maven.build.dir}/javadoc/report.txt" action="stop" />
    </j:if>
                                                                                
  </goal>
</project>
